<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 إدارة أولياء الأمور</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            direction: rtl;
            text-align: right;
        }

        .card {
            border-radius: 15px;
        }

        .btn {
            font-weight: bold;
        }

        .loading {
            color: gray;
            font-size: 14px;
        }

        .child-table {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
       
        <div class="text-end mb-3">
            <a href="students.html" target="_blank" class="btn btn-outline-primary">👦 صفحة الطلاب</a>
        </div>

        <h2 class="text-center text-primary mb-4">👨‍👩‍👧 إدارة أولياء الأمور</h2>

        <!-- Show All Parents -->
        <div class="card p-4 shadow mb-4">
            <h5>عرض كل أولياء الأمور</h5>
            <button id="btnGetAll" class="btn btn-success mb-3">عرض الكل</button>
            <div id="parentsContainer"></div>
        </div>

        <!-- Add Parent -->
        <div class="card p-4 shadow mb-4">
            <h5>إضافة ولي أمر جديد</h5>
            <div class="row g-2">
                <div class="col-md-3"><input type="text" id="addName" class="form-control" placeholder="اسم ولي الأمر"></div>
                <div class="col-md-3"><input type="email" id="addEmail" class="form-control" placeholder="البريد الإلكتروني"></div>
                <div class="col-md-3"><input type="text" id="addPhone" class="form-control" placeholder="رقم التليفون"></div>
                <div class="col-md-3"><button id="btnAdd" class="btn btn-primary w-100">إضافة</button></div>
            </div>
            <div id="addMsg" class="mt-2"></div>
        </div>

        <!-- Update Parent -->
        <div class="card p-4 shadow mb-4">
            <h5>تحديث بيانات ولي الأمر</h5>
            <div class="row g-2">
                <div class="col-md-2"><input type="number" id="updateId" class="form-control" placeholder="ID ولي الأمر" readonly></div>
                <div class="col-md-3"><input type="text" id="updateName" class="form-control" placeholder="الاسم الجديد"></div>
                <div class="col-md-3"><input type="email" id="updateEmail" class="form-control" placeholder="البريد الإلكتروني الجديد"></div>
                <div class="col-md-3"><input type="text" id="updatePhone" class="form-control" placeholder="رقم التليفون الجديد"></div>
                <div class="col-md-1"><button id="btnUpdate" class="btn btn-warning w-100">تحديث</button></div>
            </div>
            <div id="updateMsg" class="mt-2"></div>
        </div>

        <script>
            const apiBase = "http://localhost:5150/api/parent";
            const token = localStorage.getItem("token");

            $("#btnGetAll").click(function () {
                $("#parentsContainer").html("<div class='loading'>جارِ التحميل...</div>");
                $.ajax({
                    url: apiBase,
                    method: "GET",
                    headers: { "Authorization": "Bearer " + token },
                    success: data => showParents(data),
                    error: () => $("#parentsContainer").html("<div class='alert alert-danger'>فشل في الاتصال بالسيرفر ❌</div>")
                });
            });

            // إضافة
            $("#btnAdd").click(function () {
                const dto = {
                    parentName: $("#addName").val(),
                    email: $("#addEmail").val(),
                    phoneNumber: $("#addPhone").val()
                };
                $.ajax({
                    url: apiBase,
                    method: "POST",
                    headers: { "Authorization": "Bearer " + token },
                    contentType: "application/json",
                    data: JSON.stringify(dto),
                    success: () => {
                        $("#addMsg").html("<div class='alert alert-success'>تمت الإضافة ✅</div>");
                        $("#btnGetAll").click();
                    },
                    error: () => $("#addMsg").html("<div class='alert alert-danger'>فشل في الإضافة ❌</div>")
                });
            });

            
            $("#btnUpdate").click(function () {
                const id = $("#updateId").val();
                const dto = {
                    parentName: $("#updateName").val(),
                    email: $("#updateEmail").val(),
                    phoneNumber: $("#updatePhone").val()
                };
                $.ajax({
                    url: `${apiBase}/${id}`,
                    method: "PUT",
                    headers: { "Authorization": "Bearer " + token },
                    contentType: "application/json",
                    data: JSON.stringify(dto),
                    success: () => {
                        $("#updateMsg").html("<div class='alert alert-success'>تم التحديث ✅</div>");
                        $("#btnGetAll").click();
                    },
                    error: () => $("#updateMsg").html("<div class='alert alert-danger'>فشل في التحديث ❌</div>")
                });
            });

            
            function showParents(data) {
                if (!data || data.length === 0) {
                    $("#parentsContainer").html("<div class='alert alert-warning'>لا يوجد بيانات</div>");
                    return;
                }
                let table = `
                            <table class="table table-bordered table-striped text-center">
                                <thead class="table-dark">
                                    <tr><th>ID</th><th>الاسم</th><th>البريد الإلكتروني</th><th>رقم التليفون</th><th>الإجراءات</th></tr>
                                </thead>
                                <tbody>
                        `;
                data.forEach(p => {
                    table += `
                                <tr data-parent-id="${p.parentId ?? p.ParentId}">
                                    <td>${p.parentId ?? p.ParentId}</td>
                                    <td>${p.parentName ?? p.ParentName}</td>
                                    <td>${p.email ?? p.Email}</td>
                                    <td>${p.phoneNumber ?? p.PhoneNumber}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm btn-edit"
                                                data-id="${p.parentId ?? p.ParentId}"
                                                data-name="${p.parentName ?? p.ParentName}"
                                                data-email="${p.email ?? p.Email}"
                                                data-phone="${p.phoneNumber ?? p.PhoneNumber}">تعديل</button>
                                        <button class="btn btn-danger btn-sm btn-delete" data-id="${p.parentId ?? p.ParentId}">حذف</button>
                                        <button class="btn btn-info btn-sm btn-students" data-id="${p.parentId ?? p.ParentId}">عرض الأبناء</button>
                                    </td>
                                </tr>
                                <tr class="child-row" style="display:none;">
                                    <td colspan="5"><div class="child-container"></div></td>
                                </tr>`;
                });
                table += "</tbody></table>";
                $("#parentsContainer").html(table);

                $(".btn-edit").click(function () {
                    const id = $(this).data("id"), name = $(this).data("name"), email = $(this).data("email"), phone = $(this).data("phone");
                    $("#updateId").val(id);
                    $("#updateName").val(name);
                    $("#updateEmail").val(email);
                    $("#updatePhone").val(phone);
                    $("html, body").animate({ scrollTop: $("#updateId").offset().top - 20 }, 500);
                });

                $(".btn-delete").click(function () {
                    const id = $(this).data("id");
                    if (!confirm("هل أنت متأكد من حذف هذا ولي الأمر؟")) return;
                    $.ajax({
                        url: `${apiBase}/${id}`,
                        method: "DELETE",
                        headers: { "Authorization": "Bearer " + token },
                        success: () => { alert("تم الحذف ✅"); $("#btnGetAll").click(); },
                        error: () => alert("فشل في الحذف ❌")
                    });
                });

                $(".btn-students").click(function () {
                    const btn = $(this);
                    const parentRow = btn.closest("tr");
                    const childRow = parentRow.next(".child-row");
                    const childContainer = childRow.find(".child-container");

                    if (childRow.is(":visible")) {
                        childRow.hide();
                        return;
                    }

                    childRow.show();
                    childContainer.html("<div class='loading'>جارِ التحميل...</div>");
                    const parentId = btn.data("id");
                    $.ajax({
                        url: `${apiBase}/${parentId}/students`,
                        method: "GET",
                        headers: { "Authorization": "Bearer " + token },
                        success: data => showStudents(data, childContainer),
                        error: () => childContainer.html("<div class='alert alert-warning'>لا يوجد أبناء لهذا ولي الأمر</div>")
                    });
                });
            }

            function showStudents(data, container) {
                if (!data || data.length === 0) {
                    container.html("<div class='alert alert-warning'>لا يوجد أبناء</div>");
                    return;
                }
                let table = `
                            <table class="table table-bordered table-striped text-center child-table">
                                <thead class="table-secondary">
                                    <tr><th>ID</th><th>الاسم</th><th>الصف</th><th>العمر</th><th>Parent ID</th></tr>
                                </thead>
                                <tbody>`;
                data.forEach(s => {
                    table += `
                                <tr>
                                    <td>${s.studentId ?? s.StudentId}</td>
                                    <td>${s.studentName ?? s.StudentName}</td>
                                    <td>${s.grade ?? s.Grade}</td>
                                    <td>${s.age ?? s.Age}</td>
                                    <td>${s.parentId ?? s.ParentId}</td>
                                </tr>`;
                });
                table += "</tbody></table>";
                container.html(table);
            }
        </script>
</body>
</html>
